<template>
    <div class="sms-chat">
        <div v-if="!isLoading && chat.length == 0" class="row">
            <div class="col-3 empty-chat">
                You have no Chat
            </div>
        </div>
        <div class="row" v-else-if="!isLoading && chat.length > 0">
            <div class="col-3">
                <div class="chat_profile_div bg-white box_shadow_reg border-radius-reg">
<!--                    <div class="head_div d-flex align-items-center">-->
<!--                        <div class="icon_div">-->
<!--                            <svg width="20" height="23" viewBox="0 0 20 23" fill="none" xmlns="http://www.w3.org/2000/svg">-->
<!--                                <path d="M9.27763 0H9.63296C10.5004 0.0399805 11.3674 0.246621 12.1248 0.680117C13.1993 1.2951 14.0874 2.25463 14.5694 3.39879C15.0119 4.45715 15.0887 5.65342 14.856 6.77152C14.5582 8.17982 13.6395 9.41113 12.45 10.2013C11.5264 10.8176 10.4052 11.1069 9.29919 11.071C8.25341 11.0566 7.21033 10.7359 6.35097 10.1357C5.27419 9.38732 4.42697 8.2773 4.09769 6.99838C3.78728 5.81334 3.86005 4.52139 4.33218 3.38801C4.81419 2.25598 5.69062 1.30498 6.75302 0.690449C7.51894 0.248867 8.39806 0.0363867 9.27763 0Z" fill="#5590F5"/>-->
<!--                                <path d="M2.69339 11.7681C3.40001 11.3221 4.2405 11.1006 5.0747 11.1168C5.26517 11.1199 5.44576 11.1913 5.61017 11.2834C6.14788 11.5889 6.64337 11.9662 7.18783 12.2609C7.97081 12.6311 8.82568 12.8961 9.70076 12.8665C10.4793 12.8606 11.229 12.6082 11.932 12.2937C12.3988 12.0574 12.8192 11.7416 13.2644 11.4689C13.5241 11.3131 13.7891 11.1248 14.104 11.1168C15.1314 11.0943 16.1727 11.4375 16.9556 12.1095C17.4489 12.5426 17.8415 13.0848 18.1308 13.6724C18.5019 14.3727 18.7318 15.1391 18.8882 15.914C19.124 17.0316 19.2085 18.178 19.1775 19.319C19.1541 19.7984 19.0607 20.2772 18.8778 20.7224C18.5948 21.4241 18.0706 22.0202 17.4246 22.4115C16.7849 22.8032 16.0352 22.9716 15.2917 22.9999H3.84204C2.94585 22.9582 2.03439 22.6949 1.3381 22.1105C0.69392 21.5907 0.252338 20.8347 0.0973573 20.023C-0.0284239 19.43 -0.00461544 18.8204 0.0182947 18.2189C0.0407557 17.6691 0.08433 17.1188 0.177768 16.5761C0.336342 15.5762 0.57892 14.5744 1.05419 13.6737C1.42974 12.9172 1.97015 12.2191 2.69339 11.7681Z" fill="#5590F5"/>-->
<!--                            </svg>-->
<!--                        </div>-->
<!--                        <h5 class="text-white mb-0 font-400">Profile Name</h5>-->
<!--                        <button class="btn_add">-->
<!--                            <svg width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg">-->
<!--                                <path d="M10.3171 0H10.6825C11.7785 0.0270703 12.8719 0.21082 13.9088 0.570117C16.2479 1.3691 18.277 3.02859 19.5325 5.15648C20.4627 6.70975 20.9635 8.5091 21 10.3175V10.6825C20.966 12.2887 20.571 13.8887 19.827 15.3144C18.5838 17.7306 16.3697 19.6268 13.7862 20.4713C12.7858 20.8035 11.7354 20.9742 10.6829 21H10.3175C8.53986 20.9635 6.77086 20.4799 5.23523 19.58C3.20045 18.3996 1.5791 16.5195 0.724336 14.3268C0.265371 13.1685 0.0295313 11.9269 0 10.6829V10.3175C0.034043 8.72156 0.423691 7.13139 1.15869 5.71266C2.15455 3.77057 3.77057 2.15455 5.71266 1.15869C7.13139 0.423691 8.72115 0.034043 10.3171 0ZM9.89625 1.64883C8.15842 1.7649 6.4534 2.40434 5.08553 3.48551C4.25701 4.11674 3.55564 4.90711 2.99045 5.78033C1.84201 7.58625 1.39371 9.8175 1.74357 11.9278C1.97736 13.3641 2.56717 14.7468 3.46828 15.8911C4.08926 16.7147 4.86937 17.4107 5.72906 17.9771C7.23434 18.9451 9.03861 19.4373 10.8269 19.3647C12.5237 19.3069 14.2037 18.747 15.5863 17.7602C16.8697 16.8537 17.9173 15.6105 18.5719 14.1807C19.3873 12.4085 19.5862 10.3634 19.1358 8.46562C18.6818 6.49852 17.5124 4.71393 15.9145 3.48551C14.23 2.15209 12.036 1.49748 9.89625 1.64883Z" fill="white"/>-->
<!--                                <path d="M9.68708 6.3539C9.68011 5.92324 10.0677 5.53769 10.4988 5.54958C10.9299 5.53769 11.3175 5.92324 11.3105 6.3539C11.3199 7.43712 11.3031 8.52158 11.3187 9.6048C12.3995 9.62449 13.4814 9.6048 14.5626 9.61423C14.8214 9.61505 15.0778 9.74302 15.2263 9.9563C15.3907 10.1848 15.4235 10.5014 15.305 10.7573C15.1815 11.0461 14.876 11.2434 14.5618 11.2376C13.481 11.2442 12.3995 11.2311 11.3191 11.2438C11.3039 12.1437 11.3175 13.0448 11.3125 13.9451C11.3076 14.1723 11.3269 14.4008 11.2978 14.6268C11.2449 14.9918 10.911 15.292 10.5418 15.301C10.2211 15.3257 9.90201 15.1325 9.76665 14.8421C9.65509 14.6144 9.68995 14.354 9.68462 14.1091C9.68052 13.1539 9.69365 12.1982 9.67847 11.2438C8.58417 11.2298 7.48864 11.2467 6.39393 11.2356C5.98542 11.2294 5.62981 10.8652 5.62243 10.4592C5.59905 10.0757 5.88575 9.7057 6.26268 9.63351C6.49688 9.59373 6.73518 9.61874 6.97143 9.61259C7.87378 9.60685 8.77694 9.62367 9.67888 9.6048C9.69447 8.52158 9.67765 7.43753 9.68708 6.3539Z" fill="white"/>-->
<!--                            </svg>-->
<!--                        </button>-->
<!--                    </div>-->
                    <div class="search_div">
                        <div class="search_group">
                            <input class="input-search" placeholder="Searching..." v-model="search"  v-on:keyup="searchCustomer">
                            <button class="btn_search">
                                <svg width="18" height="18" viewBox="0 0 18 18" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7.33184 0H7.88977C8.05676 0.0154688 8.2234 0.0309375 8.39039 0.0446484C9.72141 0.183867 11.0162 0.679219 12.0895 1.48008C12.7378 1.9473 13.3035 2.52668 13.7693 3.17531C14.8605 4.67367 15.3366 6.6034 15.0732 8.4375C14.915 9.64441 14.438 10.8039 13.7197 11.7851C13.5657 12.0227 13.3545 12.2161 13.1924 12.4471C13.9096 13.1783 14.6528 13.886 15.3787 14.6099C16.1824 15.3998 16.9854 16.1902 17.7887 16.9808C17.885 17.0722 17.9525 17.1886 18 17.3123V17.5279C17.9388 17.7581 17.7567 17.9364 17.5279 18H17.3123C17.1763 17.9575 17.0518 17.8836 16.952 17.7824C15.4786 16.3259 13.9982 14.8767 12.5244 13.4205C12.4646 13.3625 12.4066 13.3014 12.3381 13.2536C12.099 13.3952 11.8948 13.5896 11.6508 13.725C9.84691 14.8764 7.5484 15.203 5.49176 14.6183C4.19273 14.2559 2.99742 13.5323 2.06613 12.5585C1.04344 11.5024 0.344531 10.1348 0.105117 8.68324C0.0523828 8.38582 0.0316406 8.08418 0 7.7843V7.19156C0.0404297 6.50988 0.142734 5.82891 0.361055 5.17992C0.927422 3.41578 2.19551 1.89914 3.80707 0.993164C4.87371 0.370547 6.10172 0.0513281 7.33184 0ZM6.90715 1.1816C5.5452 1.32645 4.22613 1.90125 3.21926 2.83395C2.60051 3.39469 2.09672 4.08199 1.74586 4.83961C1.0357 6.3552 0.982266 8.16293 1.5982 9.71859C2.25316 11.4131 3.68297 12.7839 5.39859 13.3784C6.95355 13.9405 8.72613 13.8674 10.2319 13.1857C11.6068 12.5715 12.7564 11.4571 13.3893 10.0881C14.1852 8.41641 14.1701 6.38191 13.3436 4.7243C12.5543 3.07969 11.0092 1.82812 9.24609 1.37039C8.48707 1.15875 7.68973 1.1148 6.90715 1.1816Z" fill="#707070"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="profile_div">
                        <div class="profile_box d-flex align-items-center" v-for="(profile, pindex) in filterChat" @click="currentActiveMessage = profile">
<!--                            <div class="icon_div">-->
<!--                                <svg width="20" height="23" viewBox="0 0 20 23" fill="none" xmlns="http://www.w3.org/2000/svg">-->
<!--                                    <path d="M9.27763 0H9.63296C10.5004 0.0399805 11.3674 0.246621 12.1248 0.680117C13.1993 1.2951 14.0874 2.25463 14.5694 3.39879C15.0119 4.45715 15.0887 5.65342 14.856 6.77152C14.5582 8.17982 13.6395 9.41113 12.45 10.2013C11.5264 10.8176 10.4052 11.1069 9.29919 11.071C8.25341 11.0566 7.21033 10.7359 6.35097 10.1357C5.27419 9.38732 4.42697 8.2773 4.09769 6.99838C3.78728 5.81334 3.86005 4.52139 4.33218 3.38801C4.81419 2.25598 5.69062 1.30498 6.75302 0.690449C7.51894 0.248867 8.39806 0.0363867 9.27763 0Z" fill="#5590F5"/>-->
<!--                                    <path d="M2.69339 11.7681C3.40001 11.3221 4.2405 11.1006 5.0747 11.1168C5.26517 11.1199 5.44576 11.1913 5.61017 11.2834C6.14788 11.5889 6.64337 11.9662 7.18783 12.2609C7.97081 12.6311 8.82568 12.8961 9.70076 12.8665C10.4793 12.8606 11.229 12.6082 11.932 12.2937C12.3988 12.0574 12.8192 11.7416 13.2644 11.4689C13.5241 11.3131 13.7891 11.1248 14.104 11.1168C15.1314 11.0943 16.1727 11.4375 16.9556 12.1095C17.4489 12.5426 17.8415 13.0848 18.1308 13.6724C18.5019 14.3727 18.7318 15.1391 18.8882 15.914C19.124 17.0316 19.2085 18.178 19.1775 19.319C19.1541 19.7984 19.0607 20.2772 18.8778 20.7224C18.5948 21.4241 18.0706 22.0202 17.4246 22.4115C16.7849 22.8032 16.0352 22.9716 15.2917 22.9999H3.84204C2.94585 22.9582 2.03439 22.6949 1.3381 22.1105C0.69392 21.5907 0.252338 20.8347 0.0973573 20.023C-0.0284239 19.43 -0.00461544 18.8204 0.0182947 18.2189C0.0407557 17.6691 0.08433 17.1188 0.177768 16.5761C0.336342 15.5762 0.57892 14.5744 1.05419 13.6737C1.42974 12.9172 1.97015 12.2191 2.69339 11.7681Z" fill="#5590F5"/>-->
<!--                                </svg>-->
<!--                            </div>-->
                            <div class="content_div">
                                <h5 class="mb-1 font-400"><span v-if="profile.customer.name != ''">{{profile.customer.name}}</span><span v-else>{{profile.customer.phone}}</span>
                                    <span class="text-gray d-inline-block float-right small-font">{{profile.messages[profile.messages.length - 1].dateCreated}}</span></h5>
                                <p class="mb-0 text-gray small-font truncate">{{profile.messages[profile.messages.length - 1].body}}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-9">
                <div class="chat_div bg-white box_shadow_reg border-radius-reg">
                    <div class="head_div align-items-center">
<!--                        <div class="icon_div">-->
<!--                            <svg width="20" height="23" viewBox="0 0 20 23" fill="none" xmlns="http://www.w3.org/2000/svg">-->
<!--                                <path d="M9.27763 0H9.63296C10.5004 0.0399805 11.3674 0.246621 12.1248 0.680117C13.1993 1.2951 14.0874 2.25463 14.5694 3.39879C15.0119 4.45715 15.0887 5.65342 14.856 6.77152C14.5582 8.17982 13.6395 9.41113 12.45 10.2013C11.5264 10.8176 10.4052 11.1069 9.29919 11.071C8.25341 11.0566 7.21033 10.7359 6.35097 10.1357C5.27419 9.38732 4.42697 8.2773 4.09769 6.99838C3.78728 5.81334 3.86005 4.52139 4.33218 3.38801C4.81419 2.25598 5.69062 1.30498 6.75302 0.690449C7.51894 0.248867 8.39806 0.0363867 9.27763 0Z" fill="#5590F5"/>-->
<!--                                <path d="M2.69339 11.7681C3.40001 11.3221 4.2405 11.1006 5.0747 11.1168C5.26517 11.1199 5.44576 11.1913 5.61017 11.2834C6.14788 11.5889 6.64337 11.9662 7.18783 12.2609C7.97081 12.6311 8.82568 12.8961 9.70076 12.8665C10.4793 12.8606 11.229 12.6082 11.932 12.2937C12.3988 12.0574 12.8192 11.7416 13.2644 11.4689C13.5241 11.3131 13.7891 11.1248 14.104 11.1168C15.1314 11.0943 16.1727 11.4375 16.9556 12.1095C17.4489 12.5426 17.8415 13.0848 18.1308 13.6724C18.5019 14.3727 18.7318 15.1391 18.8882 15.914C19.124 17.0316 19.2085 18.178 19.1775 19.319C19.1541 19.7984 19.0607 20.2772 18.8778 20.7224C18.5948 21.4241 18.0706 22.0202 17.4246 22.4115C16.7849 22.8032 16.0352 22.9716 15.2917 22.9999H3.84204C2.94585 22.9582 2.03439 22.6949 1.3381 22.1105C0.69392 21.5907 0.252338 20.8347 0.0973573 20.023C-0.0284239 19.43 -0.00461544 18.8204 0.0182947 18.2189C0.0407557 17.6691 0.08433 17.1188 0.177768 16.5761C0.336342 15.5762 0.57892 14.5744 1.05419 13.6737C1.42974 12.9172 1.97015 12.2191 2.69339 11.7681Z" fill="#5590F5"/>-->
<!--                            </svg>-->
<!--                        </div>-->
                        <h5 class="text-white mb-0 font-400">{{currentActiveMessage.customer.name}}</h5>
                        <h5 class="text-white mb-0">{{currentActiveMessage.customer.phone}}</h5>
                    </div>
                    <div class="chat_div_inner">
                        <div class="chat_main" v-for="(message, index) in currentActiveMessage.messages">
                            <div class="chat_box" :class="[message.author == 'system' ? 'right-chat' : 'left-chat']">
                                {{message.body}}
                            </div>
                            <p :class="[message.author == 'system' ? 'text-right pr-2' : 'pl-2']" class="text-gray small-font mb-0">{{message.dateCreated}}</p>
                        </div>
<!--                        <div class="chat_day_end">-->
<!--                            <p class="mb-0 text-gray text-center small-font bg-white">July 13, 2021</p>-->
<!--                        </div>-->
                    </div>
                    <div class="chat_footer">
                        <div class="left_btn_div">
                        </div>
                        <div class="inuput_div_send d-flex">
                            <input type="text" placeholder="Type..." name="" v-model="form.message" maxlength="153"/>
                            <button class="btn_sent" @click="sendMessage()" :class="{'Polaris-Button--disabled' : ( form.message == '' && form.message.length > 0 && form.message.length <= 153 )}">
                                <svg width="18" height="16" viewBox="0 0 18 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M0.220679 0.138155C0.405636 -0.012748 0.677062 -0.0421274 0.892066 0.0603667C6.16133 2.49352 11.4316 4.92466 16.7015 7.35681C16.9145 7.44695 17.0624 7.64893 17.0935 7.87729V7.98145C17.0661 8.10064 17.0314 8.22417 16.9486 8.31798C16.8698 8.41246 16.7599 8.47222 16.6504 8.52397C11.4046 10.9448 6.15866 13.3656 0.912765 15.7867C0.687411 15.9012 0.390279 15.8842 0.203319 15.7049C0.0781225 15.6037 0.0243716 15.4465 0 15.2929V15.2218C0.0206991 15.0983 0.0547525 14.9738 0.133209 14.8736C1.52606 13.0167 2.91858 11.1598 4.31143 9.30253C4.65096 8.84381 5.00251 8.3931 5.33537 7.92904C4.98448 7.43927 4.6129 6.96386 4.25467 6.4791C2.88519 4.65424 1.51738 2.82837 0.147231 1.00418C0.0617635 0.899349 0.0203653 0.768477 0 0.636937V0.565158C0.0273763 0.404907 0.0858012 0.239648 0.220679 0.138155Z" fill="white"/>
                                </svg>
                            </button>
                        </div>
                          <p class="character_text">Characters: {{ form.message.length }}/153</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="sms-chat-loader" v-else >
            <div class="spinner-border" id="loading" role="status">
                <span class="sr-only">Loading...</span>
            </div>
        </div>
    </div>
</template>

<script>

export default {
    name: "SmsChat",
    data(){
        return{
            isLoading: true,
            from: '',
            search: '',
            filterChat: [],
            chat: [],
            currentActiveMessage: [],
            form:{
                message: '',
                conversationId: '',
                phone: '',
            }
        }
    },
    methods: {
        async getData(){
            let base = this;
            base.isLoading = true;
            await axios.get('sms/chat')
                .then(res => {
                    let data = res.data.data;

                    if(data.chat.length > 0){
                        base.chat = data.chat;
                        base.from = data.from;
                        base.currentActiveMessage = base.chat[0];
                        base.filterChat = base.chat;
                    }

                })
                .catch(err => {
                    console.log(err);
                })
                .finally(res => {
                    base.isLoading = false;
                });
        },
        searchCustomer(){
            let f = [];
            for(var i=0; i<this.chat.length;i++){
                let name = this.chat[i].customer.name;
                let phone = this.chat[i].customer.phone;
               if(name.includes(this.search) || phone.includes(this.search) ){
                    f.push(this.chat[i]);
               }
            }
            this.filterChat = f;
        },
        async sendMessage(){
            let base = this;

            if(this.form.message.length <= 0 || this.form.message.length >= 153){
                return;
            }
            this.form.conversationId = this.currentActiveMessage.messages[0].conversationSid;
            this.form.phone = this.currentActiveMessage.customer.phone;
            await axios.post('sms/chat', {data: this.form})
                .then(res => {
                    let data = res.data;
                    if(data.isSuccess){
                        let m = {
                            'author': "system",
                            'body': this.form.message,
                            'conversationSid': this.form.conversationId,
                            'dateCreated': data.date
                        }
                        this.currentActiveMessage.messages.push(m);

                        this.form.message = '';
                        this.form.conversationId = '';
                    }
                })
                .catch(err => {
                    console.log(err);
                })
                .finally(res => {
                    base.isLoading = false;
                });
        }
    },
    mounted() {
        this.getData();
    }
}
</script>

<style scoped>
.sms-chat-loader {
    display: flex;
    align-items: center;
    height: 100%;
    justify-content: center;
}
.sms-chat .chat_profile_div .profile_div .profile_box:hover {
    cursor: pointer;
}

#loading {
  display: inline-block;
  width: 50px;
  height: 50px;
  border: 3px solid #5590F5;
  border-radius: 50%;
  border-top-color: #fff;
  animation: spin 1s ease-in-out infinite;
  -webkit-animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}
@-webkit-keyframes spin {
  to { -webkit-transform: rotate(360deg); }
}
.empty-chat{
    padding: 20px;
    font-weight: 900;
    font-size: 24px;
}
</style>
